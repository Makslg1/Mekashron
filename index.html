<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - ICU Tech</title>

    <style>
        /* Критические стили inline для быстрой отрисовки */
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --success-color: #10b981;
            --error-color: #ef4444;
            --bg-color: #f8fafc;
            --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-color);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        /* Навигация */
        .navbar {
            background: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: #1e293b;
        }

        .nav-link {
            color: #64748b;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        /* Основной контейнер */
        .main-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 76px);
            padding: 2rem 1rem;
        }

        /* Карточка входа */
        .login-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
        }

        .login-card h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Поля ввода */
        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* Кнопка входа */
        .btn-signin {
            background: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 0.875rem;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            color: #fff;
            transition: background 0.2s, transform 0.1s;
        }

        .btn-signin:hover {
            background: var(--primary-hover);
        }

        .btn-signin:active {
            transform: scale(0.98);
        }

        .btn-signin:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        /* Сообщения */
        .alert-message {
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .alert-success {
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .alert-message.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Спиннер загрузки */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Респонсивность */
        @media (max-width: 576px) {
            .login-card {
                padding: 1.5rem;
                border-radius: 12px;
            }

            .login-card h1 {
                font-size: 1.5rem;
            }
        }

        /* Bootstrap-like utilities inline */
        .container {
            width: 100%;
            max-width: 1140px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 1.5rem;
        }

        .navbar-toggler {
            display: none;
            background: none;
            border: 1px solid #dee2e6;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .navbar-toggler-icon {
            display: block;
            width: 1.5rem;
            height: 1.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%2833, 37, 41, 0.75%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100%;
        }

        .navbar > .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }

        @media (max-width: 768px) {
            .navbar-toggler {
                display: block;
            }

            .navbar-collapse {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #fff;
                padding: 1rem;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }

            .navbar-collapse.show {
                display: block;
            }

            .navbar-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .navbar {
                position: relative;
            }
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">ICU Tech</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Support</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="main-container">
        <div class="login-card">
            <h1>Sign In</h1>

            <!-- Сообщение об успехе -->
            <div id="successMessage" class="alert-message alert-success">
                <strong>Success!</strong>
                <div id="successDetails"></div>
            </div>

            <!-- Сообщение об ошибке -->
            <div id="errorMessage" class="alert-message alert-error">
                <strong>Error!</strong>
                <span id="errorDetails"></span>
            </div>

            <!-- Форма входа -->
            <form id="loginForm" novalidate>
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input
                        type="text"
                        class="form-control"
                        id="username"
                        name="username"
                        required
                        autocomplete="username"
                        placeholder="Enter your username"
                    >
                </div>

                <div class="mb-4">
                    <label for="password" class="form-label">Password</label>
                    <input
                        type="password"
                        class="form-control"
                        id="password"
                        name="password"
                        required
                        autocomplete="current-password"
                        placeholder="Enter your password"
                    >
                </div>

                <button type="submit" class="btn-signin" id="submitBtn">
                    Sign In
                </button>
            </form>
        </div>
    </main>

    <!-- JavaScript для SOAP запросов -->
    <script>
        // Конфигурация SOAP сервиса
        const SOAP_URL = 'http://isapi.mekashron.com/icu-tech/icutech-test.dll/soap/IICUTech';
        const SOAP_ACTION = 'urn:ICUTech.Intf-IICUTech#Login';

        // DOM элементы
        const form = document.getElementById('loginForm');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        const errorMessage = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');

        // Создание SOAP конверта для Login
        function createLoginSoapEnvelope(username, password) {
            return `<?xml version="1.0" encoding="UTF-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns:xsd="http://www.w3.org/2001/XMLSchema">
    <soap:Body>
        <Login xmlns="urn:ICUTech.Intf-IICUTech">
            <UserName xsi:type="xsd:string">${escapeXml(username)}</UserName>
            <Password xsi:type="xsd:string">${escapeXml(password)}</Password>
            <IPs xsi:type="xsd:string"></IPs>
        </Login>
    </soap:Body>
</soap:Envelope>`;
        }

        // Экранирование XML символов
        function escapeXml(str) {
            return str.replace(/[<>&'"]/g, function(c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // Скрыть все сообщения
        function hideMessages() {
            successMessage.classList.remove('show');
            errorMessage.classList.remove('show');
        }

        // Показать успешное сообщение
        function showSuccess(details) {
            hideMessages();
            successDetails.innerHTML = details;
            successMessage.classList.add('show');
        }

        // Показать сообщение об ошибке
        function showError(message) {
            hideMessages();
            errorDetails.textContent = message;
            errorMessage.classList.add('show');
        }

        // Установить состояние загрузки
        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner"></span>Signing in...';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Sign In';
            }
        }

        // Парсинг SOAP ответа
        function parseSoapResponse(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // Проверка на ошибки парсинга
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                throw new Error('Invalid response from server');
            }

            // Получение результата
            const returnElement = xmlDoc.getElementsByTagName('return')[0];
            if (returnElement) {
                return returnElement.textContent;
            }

            // Проверка на SOAP Fault
            const faultString = xmlDoc.getElementsByTagName('faultstring')[0];
            if (faultString) {
                throw new Error(faultString.textContent);
            }

            throw new Error('Unexpected response format');
        }

        // Форматирование данных entity для отображения
        function formatEntityDetails(responseText) {
            // Попытка распарсить как JSON
            try {
                const data = JSON.parse(responseText.trim());

                // Проверка ResultCode из API
                if (data.ResultCode !== undefined) {
                    if (data.ResultCode < 0 || data.ResultCode === 0 && data.ResultMessage) {
                        // Ошибка
                        return { success: false, message: data.ResultMessage || 'Login failed' };
                    }
                }

                // Проверка на поле error
                if (data.error) {
                    return { success: false, message: data.error };
                }

                // Успешный ответ - собираем данные entity
                let html = '<div style="margin-top: 0.5rem;">';

                // EntityId может быть с большой или маленькой буквы
                const entityId = data.EntityID || data.EntityId;
                if (entityId) html += `<div><strong>Entity ID:</strong> ${entityId}</div>`;
                if (data.Email) html += `<div><strong>Email:</strong> ${data.Email}</div>`;
                if (data.FirstName || data.LastName) {
                    html += `<div><strong>Name:</strong> ${data.FirstName || ''} ${data.LastName || ''}</div>`;
                }
                if (data.Mobile) html += `<div><strong>Mobile:</strong> ${data.Mobile}</div>`;
                if (data.Company) html += `<div><strong>Company:</strong> ${data.Company}</div>`;
                if (data.Country) html += `<div><strong>Country:</strong> ${data.Country}</div>`;
                if (data.ResultMessage) html += `<div>${data.ResultMessage}</div>`;

                // Если нет конкретных полей, показать все
                if (!entityId && !data.Email && !data.FirstName && !data.ResultMessage) {
                    html += `<div><pre style="margin:0;font-size:0.85rem;">${JSON.stringify(data, null, 2)}</pre></div>`;
                }

                html += '</div>';

                return { success: true, html: html };
            } catch (e) {
                // Если не JSON, проверяем на ошибку
                if (responseText.toLowerCase().includes('error') ||
                    responseText.toLowerCase().includes('invalid') ||
                    responseText.toLowerCase().includes('wrong') ||
                    responseText.toLowerCase().includes('fail') ||
                    responseText.toLowerCase().includes('not found')) {
                    return { success: false, message: responseText };
                }

                // Успешный ответ в другом формате
                return {
                    success: true,
                    html: `<div style="margin-top: 0.5rem;">${responseText}</div>`
                };
            }
        }

        // Выполнение SOAP запроса
        async function performLogin(username, password) {
            const soapEnvelope = createLoginSoapEnvelope(username, password);

            const response = await fetch(SOAP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml; charset=utf-8',
                    'SOAPAction': SOAP_ACTION
                },
                body: soapEnvelope
            });

            if (!response.ok) {
                throw new Error(`HTTP Error: ${response.status}`);
            }

            const xmlText = await response.text();
            return parseSoapResponse(xmlText);
        }

        // Обработчик отправки формы
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Валидация
            if (!username || !password) {
                showError('Please fill in all fields');
                return;
            }

            hideMessages();
            setLoading(true);

            try {
                const result = await performLogin(username, password);
                const formatted = formatEntityDetails(result);

                if (formatted.success) {
                    showSuccess(formatted.html);
                } else {
                    showError(formatted.message);
                }
            } catch (error) {
                showError(error.message || 'Connection error. Please try again.');
            } finally {
                setLoading(false);
            }
        });

        // Мобильное меню
        const navToggler = document.querySelector('.navbar-toggler');
        const navCollapse = document.querySelector('.navbar-collapse');

        if (navToggler && navCollapse) {
            navToggler.addEventListener('click', function() {
                navCollapse.classList.toggle('show');
            });
        }
    </script>
</body>
</html>
